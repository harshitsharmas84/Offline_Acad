trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/*

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerRegistryServiceConnection: '$(AZURE_REGISTRY_SERVICE_CONNECTION)'
  imageRepository: 'nebula-nextjs-app'
  containerRegistry: '$(AZURE_REGISTRY_NAME).azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/offline-academy/Dockerfile'
  tag: '$(Build.BuildId)'
  appName: 'nebula-offline-academy'
  appServicePlan: 'nebula-app-service-plan'
  resourceGroup: '$(AZURE_RESOURCE_GROUP)'

stages:
  - stage: Build
    displayName: 'Build and Push to ACR'
    jobs:
      - job: BuildAndPush
        displayName: 'Build Docker Image and Push to ACR'
        steps:
          - task: UseDotNet@2
            inputs:
              version: '8.x'

          - task: Docker@2
            displayName: 'Build image'
            inputs:
              command: 'build'
              Dockerfile: $(dockerfilePath)
              tags: |
                $(containerRegistry)/$(imageRepository):$(tag)
                $(containerRegistry)/$(imageRepository):latest
              arguments: '--build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') --build-arg VCS_REF=$(Build.SourceVersion) --build-arg VERSION=$(Build.BuildNumber)'

          - task: Docker@2
            displayName: 'Push image to container registry'
            inputs:
              command: 'push'
              containerRegistry: $(dockerRegistryServiceConnection)
              repository: '$(imageRepository)'
              tags: |
                $(tag)
                latest

  - stage: Security
    displayName: 'Security Scanning'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: ContainerScan
        displayName: 'Scan container image for vulnerabilities'
        steps:
          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: 'login'
              containerRegistry: $(dockerRegistryServiceConnection)

          - task: AzureSecurityDevOpsTask@1
            displayName: 'Run Defender for Containers scan'
            inputs:
              azureSubscription: '$(AZURE_SUBSCRIPTION)'
              resourceGroupName: '$(AZURE_RESOURCE_GROUP)'
              containerRegistryName: '$(AZURE_REGISTRY_NAME)'

  - stage: Test
    displayName: 'Run Tests'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: RunTests
        displayName: 'Run application tests'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'

          - task: Npm@1
            displayName: 'Install dependencies'
            inputs:
              command: 'ci'
              workingDir: '$(Build.SourcesDirectory)/offline-academy'

          - task: Npm@1
            displayName: 'Run linter'
            inputs:
              command: 'custom'
              customCommand: 'run lint'
              workingDir: '$(Build.SourcesDirectory)/offline-academy'
            continueOnError: true

          - task: Npm@1
            displayName: 'Build application'
            inputs:
              command: 'custom'
              customCommand: 'run build'
              workingDir: '$(Build.SourcesDirectory)/offline-academy'

          - task: Npm@1
            displayName: 'Run tests'
            inputs:
              command: 'custom'
              customCommand: 'test'
              workingDir: '$(Build.SourcesDirectory)/offline-academy'
            continueOnError: true

  - stage: Deploy
    displayName: 'Deploy to Azure App Service'
    dependsOn: [Build, Test, Security]
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: Deploy
        displayName: 'Deploy to production'
        environment:
          name: production
          resourceType: AppService
          resourceId: /subscriptions/$(AZURE_SUBSCRIPTION_ID)/resourceGroups/$(AZURE_RESOURCE_GROUP)/providers/Microsoft.Web/sites/$(appName)
        strategy:
          runOnce:
            preDeploy:
              steps:
                - task: AzureWebAppContainer@1
                  displayName: 'Deploy container to App Service'
                  inputs:
                    azureSubscription: '$(AZURE_SUBSCRIPTION)'
                    appName: '$(appName)'
                    resourceGroupName: '$(AZURE_RESOURCE_GROUP)'
                    imageName: '$(containerRegistry)/$(imageRepository):$(tag)'
                    appServicePlanName: '$(appServicePlan)'

            postDeploy:
              steps:
                - task: AzureAppServiceManage@0
                  displayName: 'Start App Service'
                  inputs:
                    azureSubscription: '$(AZURE_SUBSCRIPTION)'
                    Action: 'Start Azure App Service'
                    WebAppName: '$(appName)'

  - stage: Verify
    displayName: 'Verify Deployment'
    dependsOn: Deploy
    condition: succeeded()
    jobs:
      - job: SmokeTest
        displayName: 'Run smoke tests'
        steps:
          - script: |
              echo "Checking app health..."
              for i in {1..30}; do
                STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://$(appName).azurewebsites.net/api/health)
                if [ $STATUS -eq 200 ]; then
                  echo "App is healthy!"
                  exit 0
                fi
                echo "Attempt $i: Status $STATUS, waiting..."
                sleep 10
              done
              exit 1
            displayName: 'Health check'
